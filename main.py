# main.py

import asyncio
import logging
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, BotCommand
from dotenv import load_dotenv
import os
from pathlib import Path
from data import init_test_data, tracker_data, habits_metadata, users_metadata

# ============================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ============================================================
# –ó–∞–≥—Ä—É–∑–∫–∞ .env —Ñ–∞–π–ª–∞ –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
env_path = Path(__file__).parent.parent / '.env'
load_dotenv(dotenv_path=env_path)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
BOT_TOKEN = os.getenv('BOT_CHALLENGE_TOKEN')
if not BOT_TOKEN:
    raise ValueError("BOT_CHALLENGE_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")

bot = Bot(token=BOT_TOKEN)
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FSM storage (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ –ø–∞–º—è—Ç–∏)
storage = MemoryStorage()
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–æ–±—ã—Ç–∏–π
dp = Dispatcher(storage=storage)

# ============================================================
# –ö–õ–ê–í–ò–ê–¢–£–†–ê (–í–°–ï–ì–î–ê –î–û–°–¢–£–ü–ù–ê)
# ============================================================
def get_main_keyboard() -> ReplyKeyboardMarkup:
    """–ì–ª–∞–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏"""
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [
                KeyboardButton(text="‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É"),
                KeyboardButton(text="üìä –ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏")
            ],
            [
                KeyboardButton(text="üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"),
                KeyboardButton(text="üìã –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫")
            ],
            [
                KeyboardButton(text="‚ÑπÔ∏è –ü–æ–º–æ—â—å")
            ]
        ],
        resize_keyboard=True,  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –∫–Ω–æ–ø–æ–∫
        input_field_placeholder="–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ..."
    )
    return keyboard

# ============================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î
# ============================================================
@dp.message(Command('start'))
async def start(message: types.Message):
    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –±–æ—Ç –¥–ª—è —Å–µ–º–µ–π–Ω–æ–≥–æ —á–µ–ª–ª–µ–Ω–¥–∂–∞!\n\n"
        "üí° –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.\n"
        "–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–¥–Ω–∏–º –Ω–∞–∂–∞—Ç–∏–µ–º!",
        reply_markup=get_main_keyboard()
    )
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä—É–ø–ø—ã
    if message.chat.type in ['group', 'supergroup']:
        init_test_data(message.chat.id)

@dp.message(Command('help'))
async def help(message: types.Message):
    await message.answer(
        "üìñ –ü–æ–º–æ—â—å:\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:\n"
        "‚Ä¢ ‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É - –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ\n"
        "‚Ä¢ üìä –ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏ - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏\n"
        "‚Ä¢ üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n"
        "‚Ä¢ üìã –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫ - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–∏–≤—ã—á–µ–∫\n"
        "‚Ä¢ ‚ÑπÔ∏è –ü–æ–º–æ—â—å - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É",
        reply_markup=get_main_keyboard()
    )

# ============================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö –ö–õ–ê–í–ò–ê–¢–£–†–´
# ============================================================
@dp.message(F.text == "‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É")
async def mark_habit(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É'"""
    await message.answer(
        "‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É\n\n"
        "üí° –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...",
        reply_markup=get_main_keyboard()
    )

@dp.message(F.text == "üìä –ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏")
async def my_habits(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏'"""
    await message.answer(
        "üìä –ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏\n\n"
        "üí° –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...",
        reply_markup=get_main_keyboard()
    )

# ============================================================
# –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –°–û –°–¢–ê–¢–ò–°–¢–ò–ö–û–ô
# ============================================================
def generate_statistics_text(chat_id: int) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ"""
    from datetime import datetime
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    months_ru = {
        1: "–Ø–Ω–≤–∞—Ä—å", 2: "–§–µ–≤—Ä–∞–ª—å", 3: "–ú–∞—Ä—Ç", 4: "–ê–ø—Ä–µ–ª—å",
        5: "–ú–∞–π", 6: "–ò—é–Ω—å", 7: "–ò—é–ª—å", 8: "–ê–≤–≥—É—Å—Ç",
        9: "–°–µ–Ω—Ç—è–±—Ä—å", 10: "–û–∫—Ç—è–±—Ä—å", 11: "–ù–æ—è–±—Ä—å", 12: "–î–µ–∫–∞–±—Ä—å"
    }
    month_num = datetime.now().month
    month_name = months_ru.get(month_num, "–ú–µ—Å—è—Ü")
    
    # –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å —ç–º–æ–¥–∑–∏ –∏ –¥–∞—Ç–∞–º–∏
    # –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: —ç–º–æ–¥–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    users_line = "   üë®‚Äçüíªüë®‚Äçüíªüë®‚Äçüíªüë©‚Äçüé®üë©‚Äçüé®üë©‚Äçüé®ü§±ü§±ü§±üßë‚ÄçüöÄüßë‚ÄçüöÄüßë‚ÄçüöÄüë®‚Äçüöíüë®‚Äçüöíüë®‚Äçüöí"
    
    # –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: —ç–º–æ–¥–∑–∏ –ø—Ä–∏–≤—ã—á–µ–∫
    habits_line = "   üèãÔ∏èüìöüèãÔ∏èüíäüìöüìöüìöüèãÔ∏èüìöüèãÔ∏èüèãÔ∏èüìöüèãÔ∏èüíäüìö"
    
    # –¢—Ä–µ—Ç—å—è —Å—Ç—Ä–æ–∫–∞: –¥–∞—Ç–∞ –∏ —Å—Ç–∞—Ç—É—Å—ã
    # –î–∞—Ç–∞ 22: —É—á–∏—Ç—ã–≤–∞–µ–º —á—Ç–æ 1 —ç–º–æ–¥–∑–∏ = 5 –ø—Ä–æ–±–µ–ª–æ–≤, 2 —Ü–∏—Ñ—Ä—ã = 4 –ø—Ä–æ–±–µ–ª–∞, –∑–Ω–∞—á–∏—Ç –Ω—É–∂–µ–Ω 1 –ø—Ä–æ–±–µ–ª –ø–µ—Ä–µ–¥ –¥–∞—Ç–æ–π
    date_line = "22 ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ"
    
    text = f"–∫–∞–ª–µ–Ω–¥–∞—Ä—å\n–º–µ—Å—è—Ü: {month_name}\n\n{users_line}\n{habits_line}\n{date_line}"
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML —Ç–µ–≥ <pre> –¥–ª—è –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω–æ–≥–æ —à—Ä–∏—Ñ—Ç–∞ (–ª—É—á—à–µ –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞)
    return f"<pre>{text}</pre>"

# –•—Ä–∞–Ω–∏–º ID –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
stats_message_id = {}

async def update_statistics_message(chat_id: int):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"""
    stats_text = generate_statistics_text(chat_id)
    
    try:
        if chat_id in stats_message_id:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            try:
                await bot.edit_message_text(
                    chat_id=chat_id,
                    message_id=stats_message_id[chat_id],
                    text=stats_text,
                    parse_mode="HTML"
                )
                logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã {chat_id}")
            except Exception as e:
                # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ
                logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ: {e}")
                await create_statistics_message(chat_id, stats_text)
        else:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await create_statistics_message(chat_id, stats_text)
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

async def create_statistics_message(chat_id: int, stats_text: str):
    """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç –µ–≥–æ"""
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        sent_message = await bot.send_message(
            chat_id=chat_id,
            text=stats_text,
            parse_mode="HTML"
        )
        
        # –ó–∞–∫—Ä–µ–ø–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        try:
            await bot.pin_chat_message(
                chat_id=chat_id,
                message_id=sent_message.message_id,
                disable_notification=True
            )
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞): {e}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è
        stats_message_id[chat_id] = sent_message.message_id
        logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã {chat_id}")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

@dp.message(F.text == "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
async def statistics(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'"""
    if message.chat.type not in ['group', 'supergroup']:
        await message.answer(
            "‚ùå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö!\n"
            "–î–æ–±–∞–≤—å –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.",
            reply_markup=get_main_keyboard()
        )
        return
    
    await update_statistics_message(message.chat.id)
    await message.answer(
        "‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!",
        reply_markup=get_main_keyboard()
    )

@dp.message(F.text == "üìã –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫")
async def list_habits(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫'"""
    await message.answer(
        "üìã –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫\n\n"
        "üí° –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...",
        reply_markup=get_main_keyboard()
    )

@dp.message(F.text == "‚ÑπÔ∏è –ü–æ–º–æ—â—å")
async def help_button(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ü–æ–º–æ—â—å'"""
    await help(message)  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ –∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /help

# ============================================================
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø - –ó–ê–ü–£–°–ö –ë–û–¢–ê
# ============================================================
async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞"""
    logger.info('üöÄ Challenge –±–æ—Ç –∑–∞–ø—É—â–µ–Ω!')
    
    # ============================================================
    # –ù–ê–°–¢–†–û–ô–ö–ê BOT COMMANDS MENU (–ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–û)
    # ============================================================
    # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –≤–∫–ª—é—á–∏—Ç—å –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ —Ä—è–¥–æ–º —Å –≤–ª–æ–∂–µ–Ω–∏—è–º–∏ (üìé)
    # –≠—Ç–æ –º–µ–Ω—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä—è–¥–æ–º —Å –≤–ª–æ–∂–µ–Ω–∏—è–º–∏
    #
    # commands = [
    #     BotCommand(command="start", description="üöÄ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º"),
    #     BotCommand(command="help", description="üìñ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"),
    # ]
    # await bot.set_my_commands(commands)
    # logger.info('‚úÖ Bot Commands Menu –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ')
    #
    # –ï—Å–ª–∏ –º–µ–Ω—é —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏ —Ö–æ—á–µ—à—å –µ–≥–æ –æ—Ç–∫–ª—é—á–∏—Ç—å, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É:
    # await bot.set_my_commands([])  # –û—á–∏—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ (–æ—Ç–∫–ª—é—á–∞–µ—Ç –º–µ–Ω—é)
    
    try:
        # –±–æ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É Telegram
        await dp.start_polling(bot, allowed_updates=dp.resolve_used_update_types())
    finally:
        await bot.session.close()
        logger.info('üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')

if __name__ == '__main__':
    asyncio.run(main())
